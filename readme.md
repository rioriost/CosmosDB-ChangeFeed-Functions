# Cosmos DB (NoSQL) 概要 & Hands On

## 目次

1. Cosmos DB NoSQL 概要 (1hour)
1. [Cosmos DB NoSQLの操作](./CreateAndOperationBasic_CosmosDB.md) (30min)
1. Cosmos DB Change Feed 概要 (30min)
1. Cosmos DB Change Feedの操作 (1hour)
    1. Azure Functionsの作成
    1. Azure Functionsのコーディング

## Cosmos DB for NoSQL 概要

### Cosmos DB for NoSQLとは？

- Microsoft Azureで利用できる**NoSQLデータストア**
    - いわゆる**データベース**とは異なる概念と理解するのが良い
    - ファイルの簡便性とRDBMSの高速検索の良いとこどり
    - RDBMSを補完する概念であり、排他的ではない 

- 優位性
  - **表形式でない**ドキュメント(JSON)の取り扱い
  ```JSON
  {
      "name"   : "John Smith",
      "sku"    : "20223",
      "price"  : 23.95,
      "shipTo" : { "name" : "Jane Smith",
                   "address" : "123 Maple Street",
                   "city" : "Pretendville",
                   "state" : "NY",
                   "zip"   : "12345" },
      "billTo" : { "name" : "John Smith",
                   "address" : "123 Maple Street",
                   "city" : "Pretendville",
                   "state" : "NY",
                   "zip"   : "12345" }
  }
  ```
  - 大量データの中から特定の少量データを高速に検索できる
  - データ登録を起点とするイベント起動ができイベント駆動型データ処理を実現
  - 同時アクセスなどによる高負荷時でも処理を分散してレイテンシーを落とさない
  - 地理分散を利用してアクセス元の地域に寄らない高速なアクセス速度を保証
  - マルチマスターによる高速な書き込み
  - 負荷に合わせて性能を自由に変更できる。自動調整も可能。(注:制約はある)
  - SLAで99.999%の可用性を保証
  - 1KB Readに関しては99%の処理を10ms以内で応答

- トレードオフ
  - トランザクション
      - 利用できる状況が限定的
  - 結合・集計処理
      - できないことはないが高コスト
      - 分析用途としてSynapse Linkという連携機能を装備しており、そちらで対応
   
- 優位性とトレードオフを加味すると以下のようなシステムに向いている
    - 利用者や同時アクセス数は多い方が良い
    - 蓄積されるデータは多い方が良い
    - クエリはシンプルなほうが良い
    - 1回に抽出されるデータは少ない方が良い
    - データが"HOT"な期間、蓄積して利用するのが良い
        - 長期的なデータ保存やデータ分析はBlob Storage、Spark、RDMBSなど別の仕組みに任せるほうがよい
        - 別の仕組みにデータを移すための便利な仕組み(ChangeFeed/Synapse Link)が組み込まれている

- 上記を考慮したユースケース
    - Webアプリ・モバイルアプリのデータ管理
    - IoTデバイスデータ処理
    - プロダクトカタログ
    - ログデータ管理
    - エンタープライズ・データ中継 

- 開発者向けのメリット
    - システム変更の効率化に寄与
        - データベース項目の変更があってもスキーマレスのため過去データを直さなくてよい
        - アクセス負荷の急激な変更に強い

## Cosmos DBの仕組み

### スループット(Request Unit:RU)

スループットは**コンテナーに対するアイテムの読み書き性能**を規定する。

単位は**RU(Request Unit)**で、1RU = 1KBの読み込みにかかる処理で消費されるリソースを指す。

CosmosDB for NoSQLの処理性能は、すべてこのRUで計算される。これは、以下の内部処理を含む。
- 書き込みのためのロック
- インデックスの書き込み、読み出し、検索
- データ検索でフィルター条件にヒットしなかった読み込み

そのため、基本的にはRead 1KB=1RUを基準とした場合、
- 変更 = 2~3RU
- 書き込み = 5~6RU
程度が最低でも消費される

CosmosDB for NoSQLでは、次の２つの設定を用いて性能を定義する。

- プロビジョニングスループット
    - あらかじめスループットを100RU/秒単位で定義しておき、その性能を確保(プロビジョニング)する。
    課金単位は100RU/秒で、確保された性能以上のリクエストはリクエスト超過(**429**)エラーとして弾かれる。
    - スループットの確保の仕方には「標準」と「自動(オートスケール)」の２つがある
        - 標準スループット
        常に同じRU/秒を確保する。
        - 自動(オートスケール)スループット
        最大で利用可能なRU/秒を確保し、アイドル時は最小1/10までRU/秒を下げる。

- サーバーレス
    - 使用時のみスループットを確保する。ただし、以下の制限がある
      - スループットの最大は20,000RU/秒
      - ストレージの最大量は1TBまで
    - 後述する物理パーティションの状況により、RU/秒は影響を受ける。

### データベース・コンテナー・アイテム

#### アイテム
格納の基本単位。JSONドキュメントが格納される。
JSONドキュメントの項目は
各JSONドキュメントにはユーザーが格納した項目以外にシステム管理上のプロパティがいくつか自動的に設定される。

|プロパティ名|目的|
|---|---|
|_rid|項目の一意識別子|
|_etag|オプティミスティック同時実行制御に使用されるエンティティタグ|
|_ts|項目の最終更新のタイムスタンプ(UNIX時間)|
|_self|項目のアドレス指定可能なURI|


#### コンテナー


#### データベース

データベースはコンテナーのグループ。
配下のコンテナーに対して共有スループットを設定した場合はデータベースごとにスループットを共有する


### 論理・物理パーティション

### インデクシング

### 整合性レベル

### TTL

### 接続方法

### SDK

### 

