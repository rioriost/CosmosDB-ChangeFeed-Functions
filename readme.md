# Cosmos DB (NoSQL) 概要 & Hands On

## 目次

1. Cosmos DB NoSQL 概要 (1hour)
1. Cosmos DB NoSQLの操作 (30min)
1. Cosmos DB Change Feed 概要 (30min)
1. Cosmos DB Change Feedの操作 (1hour)
    1. Azure Functionsの作成
    1. Azure Functionsのコーディング
    1. テスト

## Cosmos DB NoSQL 概要

### Cosmos DBとは？

- Microsoft Azureで利用できる**NoSQLデータストア**

- 優位性
  - **表形式でない**データモデルの取り扱い
      - **ドキュメント(JSON)**
      - キー・バリュー
      - カラムファミリー
      - **グラフ**
  - 大量データの中から特定の少量データを高速に検索できる
  - データ登録を起点とするイベント起動ができイベント駆動型データ処理を実現
  - 同時アクセスなどによる高負荷時でも処理を分散してレイテンシーを落とさない
  - 地理分散を利用してアクセス元の地域に寄らない高速なアクセス速度を保証
  - マルチマスターによる高速な書き込み
  - 負荷に合わせて性能を自由に変更できる。自動調整も可能。(注:制約はある)
  - SLAで99.999%の可用性を保証
  - 1KB Readに関しては99%の処理を10ms以内で応答

- トレードオフ
  - トランザクション
      - 利用できる状況が限定的
  - 結合・集計処理
      - できないことはないが高コスト
      - 分析用途としてSynapse Linkという連携機能を装備しており、そちらで対応
   
- 利点とトレードオフを加味すると以下のようなシステムに向いている
    - 利用者や同時アクセス数は多い方がいい
    - 蓄積されるデータは多い方がいい
    - クエリはシンプルなほうがいい
    - 1回に抽出されるデータは少ない方がいい
    - 
    - 長期的なデータ保存は別の仕組みに任せるほうがよい

- 開発者向けのメリット
    - システム変更の効率化に寄与
        - データベース項目の変更があってもスキーマレスのため過去データを直さなくてよい
        - 


## Change Feedの概要 

### CosmosDB Change Feedとは
- CosmosDBのコレクションに付随する追加・更新キュー
- 暗黙的に作成される
- 削除については記録されない(Latest Version Mode)
    - 今後、All Versions and Delete Modeの実装が予定されている(PublicPreview中)
    - ドキュメントの_TTLを短い時間で更新するという手がある
        - 受信側では_TTLを見て削除を判断する

### 実装のパターン
- Azure Functionsで実装
  - 定番かつお手軽
  - ドキュメントを引数として起動される
  - スケーリングについてはAppServicesPlanが推奨

- ChangeFeedProssessorを使った実装
  - VM等の実行基盤が必要になる
    - FunctionsはChangeFeedProcessorを裏で利用する

### デモ

### デモ環境
#### アーキテクチャー
(絵)
#### コード
(コードサンプル)

### その他留意点
- 
