# Change Feed 概要

## Change Feedとは？
  Change Feed(変更フィード)はCosmos DB for NoSQLの**コンテナーに対して行われた変更の永続的な記録**である。
  変更されたドキュメントは変更された順に並べ替えられた一覧に出力される。  
  非同期的に増分処理できる。  
  出力を複数のコンシューマー(クライアント)に分散させて並列処理することもできる。

## 対応するSDK
  以下のSDKに対応する。
  - .NET **本ハンズオンではC#+.NETを利用**
  - Java
  - Python
  - Node/JavaScript
 
## Change Feedの操作

使い方には以下のオプションがある。

|利用法|タイプ|概要|注意点|
|---|---|---|---|
|Azure Functions CosmosDBトリガー|プッシュモデル|Azure FunctionsのCosmos DBトリガーで処理|使いやすい(本ドキュメントでも以降はFunctionsに限定して説明)|
|変更フィードプロセッサの使用|プッシュモデル|独自アプリケーションで、待ち受けオブジェクトを作り、変更が来るたびに動作するプログラムを書く|実際はポーリングしている|
|プルモデル|プルモデル|既存の変更フィードに直接アクセスし、内容を取得する|クライアントが処理ペースを決めたい、データ移行などに使う|

### プッシュモデルとプルモデル

*プッシュモデル
```mermaid
graph LR
  subgraph "Cosmos DB"
    A[("コンテナー")]--逐次更新-->B[ChangeFeed]
  end
  B--ポーリング-->C[["クライアント
  AzureFunctions等"]]
```

*プルモデル
```mermaid
graph LR
  subgraph "Cosmos DB"
    A[("コンテナー")]--逐次更新-->B[ChangeFeed]
  end
  C[["クライアント
  バッチプログラム等"]]--アクセスして読み出し-->B
```
### パーティション範囲ごとの並列処理

Change Feedはコンテナーのパーティションキー範囲(パーティションのグループ)で使用できる。  
これにより次の図のように1つ、または複数のコンシューマーに分散して並列処理ができる。

<img src="https://learn.microsoft.com/ja-jp/azure/cosmos-db/media/change-feed/changefeedvisual.png" width="400">

## Change Feedのモード

### 最新バージョンモード

- フィード内のすべての項目の挿入、または最新の変更が表示される。削除はキャプチャされず、挿入・変更の違いも示されない。  
- 変更はコンテナーの始まりまでさかのぼって任意の時点から読み取ることができるが、項目が削除されるとChange Feedからも削除される。

### すべてのバージョンと削除モード(プレビュー)

- 作成・更新・削除による項目へのすべての変更が確認できる。
- 変更途中のバージョンを得ることもできる。
- 継続的バックアップが設定されていることが条件
    - 継続的バックアップの期間内の変更がキャプチャされる
- プレビュー参加には申請が必要となる

## 仕組み

<img src="https://github.com/tahayaka-microsoft/CosmosDB-ChangeFeed-Functions/assets/94338329/08a831ac-127b-4e7a-8f8e-31760d44a460">

- 監視対象コンテナーに対する挿入と変更がChange Feedに記録される。  
- Change Feedに対する複数のコンシューマーの処理をリースコンテナーに記録された情報で進行状況を管理する  
- コンシューマーとしてAzure Functionsや独自のクライアントなどがChange Feedに対してアクセスにくる
